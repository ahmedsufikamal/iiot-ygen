import { store } from '@/lib/store'; import { EquipmentStatus, TelemetryPoint } from '@/lib/types'; import { persistTelemetry } from '@/lib/telemetry-source'; export const runtime='nodejs'; export const dynamic='force-dynamic'; export async function POST(req:Request){ const body=await req.json().catch(()=>({})); const { deviceId,status,value } = body as { deviceId?:string; status?:EquipmentStatus; value?:number }; if(!deviceId) return Response.json({error:'deviceId required'},{status:400}); if(status) store.setStatus(deviceId,status); if(typeof value==='number') store.pushTelemetry(deviceId,value); else store.pushTelemetry(deviceId); const last = store.getTelemetry(deviceId).slice(-1)[0]; if (last?.metrics) await persistTelemetry(deviceId, last.metrics as any); return Response.json({ ok:true, device: store.getDevice(deviceId), last }); }
